---
- name: Bootstrap macOS locally
  hosts: macos
  connection: local
  gather_facts: yes
  serial: 1

  pre_tasks:
    - name: Skip other hosts when running locally
      meta: end_host
      when:
        - ansible_connection == 'local'
        - (ansible_facts['hostname'] | lower) != (inventory_hostname | lower)

  roles:
    - { role: macos_bootstrap,        tags: ['bootstrap'] }
    - { role: zoxide,                 tags: ['zoxide'] }

    # -------------------------
    # Bindu (mode switch)
    # -------------------------
    - { role: bindu_config_repo,      when: (bindu_mode | default('selective')) == 'full',      tags: ['config','bindu'] }
    - { role: bindu_selective,        when: (bindu_mode | default('selective')) == 'selective', tags: ['config','bindu'] }

    # -------------------------
    # Orbit
    # -------------------------
    - { role: orbit,                  tags: ['orbit'] }
    - { role: zsh_orbit,              tags: ['zsh','orbit'] }

    # -------------------------
    # Rust toolchain (dev-only)
    # -------------------------
    - { role: rustup,                 when: (rustup_enabled | default(false)) | bool, tags: ['rust','rustup'] }

    # -------------------------
    # Apogee install + shell init
    # -------------------------
    - { role: apogee_homebrew,        when: (apogee_install_method | default('brew')) == 'brew',  tags: ['apogee','brew'] }
    - { role: apogee_cargo,           when: (apogee_install_method | default('brew')) == 'cargo', tags: ['apogee','cargo'] }
    - { role: zsh_apogee,             tags: ['zsh','apogee'] }

    # dev-only shells (optional)
    - { role: fish_shell,             when: (install_fish | default(false)) | bool,       tags: ['fish'] }
    - { role: powershell,             when: (install_powershell | default(false)) | bool, tags: ['pwsh','powershell'] }

    # -------------------------
    # Prompt / terminal / tooling
    # -------------------------
    - { role: starship,               tags: ['starship','prompt'] }
    - { role: ghostty,                tags: ['ghostty'] }
    - { role: iterm,                  tags: ['iterm'] }

    - { role: pixi,                   tags: ['pixi'] }
    - { role: python_toolchain,       tags: ['python'] }
    - { role: nvim,                   when: (bindu_mode | default('selective')) == 'full',      tags: ['nvim'] }
    - { role: nvim_selective,         when: (bindu_mode | default('selective')) == 'selective', tags: ['nvim'] }

    - { role: home_shims,             tags: ['home','dotfiles'] }
    - { role: tmux_setup,             tags: ['tmux'] }
    - { role: eza,                    tags: ['eza'] }
    - { role: yazi,                   when: (yazi_enabled | default(true)) | bool, tags: ['yazi'] }

    - { role: apple_sf_fonts,         when: (enable_sf_fonts | default(false)) | bool, tags: ['fonts'] }

    - { role: uv,                     tags: ['uv'] }
    - { role: huggingface_cli,        when: (hf_cli_enabled | default(false)) | bool, tags: ['hf','huggingface'] }
    - { role: cargo_crates,           when: (cargo_enabled | default(false)) | bool, tags: ['cargo'] }

    - { role: macos_scratch,          tags: ['scratch','screencapture'] }
    - { role: atrium_stow,            tags: ['atrium','stow'] }

