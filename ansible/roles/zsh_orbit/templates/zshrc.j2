# --- Optional: p10k instant prompt if Starship is missing (must be at top)
if ! command -v starship >/dev/null 2>&1; then
  if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
    source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
  fi
fi

# Bring in zprofile for non-login interactive shells
if [[ -o interactive && ! -o login && -r "$HOME/.zprofile" ]]; then
  source "$HOME/.zprofile"
fi

# --- Orbit bootstrap
export ORBIT_HOME="{{ ORBIT_HOME | default(ansible_env.HOME + '/.orbit') }}"
export ORBIT_REMOTE="{{ ORBIT_REMOTE | default('https://github.com/suhailphotos/orbit.git') }}"
export ORBIT_BRANCH="{{ ORBIT_BRANCH | default('main') }}"

# First-time install
if [[ ! -d "$ORBIT_HOME/.git" ]]; then
  git clone --depth 1 --branch "$ORBIT_BRANCH" --quiet "$ORBIT_REMOTE" "$ORBIT_HOME" >/dev/null 2>&1
fi

# Silent background fast-forward update
if command -v git >/dev/null && [[ -d "$ORBIT_HOME/.git" ]]; then
  (
    git -C "$ORBIT_HOME" fetch --quiet
    git -C "$ORBIT_HOME" merge --ff-only "origin/$ORBIT_BRANCH" --quiet
  ) >/dev/null 2>&1 &!
fi

# Source Orbit
source "$ORBIT_HOME/core/bootstrap.zsh"
