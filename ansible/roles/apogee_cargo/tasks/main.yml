---
# roles/apogee_cargo/tasks/main.yml

- name: Apogee (cargo) | Check cargo (absolute path)
  stat:
    path: "{{ helix_user_home }}/.cargo/bin/cargo"
  register: apogee_cargo_stat

- name: Apogee (cargo) | Ensure cargo exists (include rustup if needed)
  include_role:
    name: rustup
  when: not apogee_cargo_stat.stat.exists

- name: Apogee (cargo) | Re-check cargo after rustup
  stat:
    path: "{{ helix_user_home }}/.cargo/bin/cargo"
  register: apogee_cargo_stat2

- name: Apogee (cargo) | Skip if cargo still missing
  debug:
    msg: "Skipping apogee_cargo: cargo is still missing after rustup attempt."
  when: not apogee_cargo_stat2.stat.exists

- name: Apogee (cargo) | Install apogee via cargo
  command: "{{ helix_user_home }}/.cargo/bin/cargo install --locked apogee"
  environment:
    PATH: >-
      {{
        (helix_task_path | default('')) ~
        ':' ~ (helix_user_home ~ '/.cargo/bin') ~
        ':' ~ (ansible_facts['env']['PATH'] | default(''))
      }}
  when: apogee_cargo_stat2.stat.exists
