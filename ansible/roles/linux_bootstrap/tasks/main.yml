
- name: Ensure apt cache is up-to-date
  apt:
    update_cache: yes
    cache_valid_time: 3600

# Ensure Ubuntu 'universe' (and updates/security) are enabled
- block:
    - name: Enable universe
      apt_repository:
        repo: "deb http://archive.ubuntu.com/ubuntu {{ ansible_distribution_release }} universe"
        state: present

    - name: Enable universe -updates
      apt_repository:
        repo: "deb http://archive.ubuntu.com/ubuntu {{ ansible_distribution_release }}-updates universe"
        state: present

    - name: Enable universe -security
      apt_repository:
        repo: "deb http://security.ubuntu.com/ubuntu {{ ansible_distribution_release }}-security universe"
        state: present

    - name: apt update after adding repos
      apt:
        update_cache: yes
        cache_valid_time: 0
  when: ansible_distribution == "Ubuntu"

- name: Install baseline packages on Linux
  apt:
    name: "{{ apt_packages }}"
    state: present

# --- System UTF-8 locale (Debian/Ubuntu) ---
- block:
    - name: Ensure requested locales are present in /etc/locale.gen
      lineinfile:
        path: /etc/locale.gen
        regexp: '^#?\s*{{ item }}$'
        line: '{{ item }}'
      loop: "{{ generate_locales | default([]) }}"
      when: (generate_locales | default([])) | length > 0

    - name: Run locale-gen if we touched /etc/locale.gen
      command: locale-gen
      when: (generate_locales | default([])) | length > 0

    - name: Set system default UTF-8 locale
      command: "update-locale LANG={{ default_locale }} LC_CTYPE={{ default_locale }}"
  when: ansible_facts.os_family == "Debian"

# roles/linux_bootstrap/tasks/main.yml (after apt install)
# Remember to initiate zoxide `eval "$(zoxide init zsh --cmd cd)"`
- name: Stat /usr/bin/bat
  stat: { path: /usr/bin/bat }
  register: bat_bin
  changed_when: false

- name: Stat /usr/bin/batcat
  stat: { path: /usr/bin/batcat }
  register: batcat_bin
  changed_when: false

- name: Provide 'bat' symlink to batcat
  become: yes
  file:
    src: /usr/bin/batcat
    dest: /usr/local/bin/bat
    state: link
  when: not bat_bin.stat.exists and batcat_bin.stat.exists
