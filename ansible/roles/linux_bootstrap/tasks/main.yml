# --- Clean up any stale NodeSource config so apt can run cleanly ---
- name: Remove old NodeSource list/sources if present
  become: yes
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/apt/sources.list.d/nodesource.list
    - /etc/apt/sources.list.d/nodesource.sources

- name: Remove old NodeSource lines from /etc/apt/sources.list if any
  become: yes
  ansible.builtin.lineinfile:
    path: /etc/apt/sources.list
    regexp: 'deb .*deb.nodesource.com'
    state: absent

- name: Ensure apt cache is up-to-date
  become: yes
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Check for DEB822 ubuntu.sources (Ubuntu 24.04+ default)
  stat:
    path: /etc/apt/sources.list.d/ubuntu.sources
  register: ubuntu_sources
  changed_when: false

# Ensure Ubuntu 'universe' (and updates/security) are enabled
- block:
    - name: Enable universe
      become: yes
      apt_repository:
        repo: "deb http://archive.ubuntu.com/ubuntu {{ ansible_distribution_release }} universe"
        state: present

    - name: Enable universe -updates
      become: yes
      apt_repository:
        repo: "deb http://archive.ubuntu.com/ubuntu {{ ansible_distribution_release }}-updates universe"
        state: present

    - name: Enable universe -security
      become: yes
      apt_repository:
        repo: "deb http://security.ubuntu.com/ubuntu {{ ansible_distribution_release }}-security universe"
        state: present

    - name: apt update after adding repos
      become: yes
      apt:
        update_cache: yes
        cache_valid_time: 0
  when:
    - ansible_distribution == "Ubuntu"
    - not ubuntu_sources.stat.exists

# Remove Linode legacy mirror .list files to avoid duplicate 'universe' entries
- name: Remove duplicate legacy .list files
  become: yes
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/apt/sources.list.d/archive_ubuntu_com_ubuntu.list
    - /etc/apt/sources.list.d/security_ubuntu_com_ubuntu.list
  when:
    - ansible_distribution == "Ubuntu"

# --- Optional: Node.js from NodeSource via official setup script ---
- block:
    - name: Ensure curl is installed (for NodeSource setup)
      become: yes
      ansible.builtin.apt:
        name: curl
        state: present
        update_cache: yes

    - name: Download NodeSource setup script (Node.js 20.x)
      become: yes
      ansible.builtin.get_url:
        url: https://deb.nodesource.com/setup_20.x
        dest: /tmp/nodesource_setup.sh
        mode: '0755'

    - name: Run NodeSource setup script (adds repo & key)
      become: yes
      ansible.builtin.command: /tmp/nodesource_setup.sh
      args:
        creates: /etc/apt/sources.list.d/nodesource.list

    - name: Install Node.js from NodeSource
      become: yes
      ansible.builtin.apt:
        name: nodejs
        state: present
        update_cache: yes
  when:
    - ansible_facts['os_family'] == 'Debian'
    - install_node_from_nodesource | default(false)

- name: apt update after adding repos
  become: yes
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: 0
  register: apt_update_after_repos
  failed_when: false

- name: Install baseline packages on Linux
  become: yes
  apt:
    name: "{{ apt_packages }}"
    state: present

# --- System UTF-8 locale (Debian/Ubuntu) ---
- block:
    - name: Ensure requested locales are present in /etc/locale.gen
      become: yes
      lineinfile:
        path: /etc/locale.gen
        regexp: '^#?\s*{{ item }}$'
        line: '{{ item }}'
      loop: "{{ generate_locales | default([]) }}"
      when: (generate_locales | default([])) | length > 0

    - name: Run locale-gen if we touched /etc/locale.gen
      become: yes
      command: locale-gen
      when: (generate_locales | default([])) | length > 0

    - name: Set system default UTF-8 locale
      become: yes
      command: "update-locale LANG={{ default_locale }} LC_CTYPE={{ default_locale }}"
  when: ansible_facts.os_family == "Debian"

# roles/linux_bootstrap/tasks/main.yml (after apt install)
# Remember to initiate zoxide `eval \"$(zoxide init zsh --cmd cd)\"`
- name: Stat /usr/bin/bat
  stat: { path: /usr/bin/bat }
  register: bat_bin
  changed_when: false

- name: Stat /usr/bin/batcat
  stat: { path: /usr/bin/batcat }
  register: batcat_bin
  changed_when: false

- name: Provide 'bat' symlink to batcat
  become: yes
  file:
    src: /usr/bin/batcat
    dest: /usr/local/bin/bat
    state: link
  when: not bat_bin.stat.exists and batcat_bin.stat.exists
