---
# roles/rustup/tasks/main.yml
# Goal:
# - Ensure cargo exists.
# - On macOS: install rustup (brew) + stable toolchain (cargo ends up in ~/.cargo/bin).
# - On Debian: fallback to apt cargo/rustc if cargo missing.

- name: Defaults (no deprecated vars)
  set_fact:
    rustup_owner: "{{ rustup_owner | default(ansible_facts['user_id'], true) }}"
    rustup_group: "{{ rustup_group | default(ansible_facts['user_id'], true) }}"
    rustup_home: "{{ rustup_home | default(helix_user_home, true) }}"
    rustup_cargo_bin: "{{ (rustup_home | default(helix_user_home, true)) ~ '/.cargo/bin/cargo' }}"
    rustup_path_effective: >-
      {{
        (helix_task_path_effective | default(helix_task_path | default('', true), true))
        ~ ':' ~ (ansible_facts['env']['PATH'] | default('', true))
      }}

- name: Ensure ~/.local/bin exists
  file:
    path: "{{ rustup_home }}/.local/bin"
    state: directory
    mode: "0755"

- name: Check for cargo (direct path)
  stat:
    path: "{{ rustup_cargo_bin }}"
  register: rustup_cargo_stat

# -----------------------------
# macOS: rustup via Homebrew
# -----------------------------
- block:
    - name: Install rustup via Homebrew
      homebrew:
        name: rustup
        state: present

    - name: Ensure stable toolchain installed (provides cargo)
      command: rustup toolchain install stable
      args:
        creates: "{{ rustup_home }}/.rustup/toolchains"
      environment:
        PATH: "{{ rustup_path_effective }}"
      changed_when: false
      failed_when: false

    - name: Set default toolchain to stable
      command: rustup default stable
      environment:
        PATH: "{{ rustup_path_effective }}"
      changed_when: false
      failed_when: false

    - name: Re-check for cargo (direct path)
      stat:
        path: "{{ rustup_cargo_bin }}"
      register: rustup_cargo_stat2

    - name: Fail if cargo still missing after rustup (macOS)
      fail:
        msg: "rustup ran but cargo is still missing at {{ rustup_cargo_bin }}."
      when: not rustup_cargo_stat2.stat.exists

  when:
    - ansible_facts['system'] == 'Darwin'
    - not rustup_cargo_stat.stat.exists

# -----------------------------
# Debian/Ubuntu fallback (only if cargo missing)
# -----------------------------
- block:
    - name: Install cargo/rustc via apt (fallback)
      become: yes
      apt:
        name:
          - cargo
          - rustc
        state: present
        update_cache: yes

  when:
    - ansible_facts['os_family'] == 'Debian'
    - not rustup_cargo_stat.stat.exists
