---
# roles/rustup/tasks/main.yml
# Goal:
# - Ensure a working cargo exists.
# - On macOS: use Homebrew rustup-init, then run rustup-init non-interactively.
# - On Debian/Ubuntu: install cargo via apt if missing.
# - Never rely on PATH being updated by shell dotfiles.
# - Never use ansible_env / ansible_user (avoids INJECT_FACTS_AS_VARS deprecation noise).
# - Never hard-fail the play.

- name: Rustup | Define paths
  set_fact:
    rustup_cargo_home: "{{ helix_user_home }}/.cargo"
    rustup_rustup_home: "{{ helix_user_home }}/.rustup"
    rustup_cargo_bin: "{{ helix_user_home }}/.cargo/bin"
    rustup_cargo_path: "{{ helix_user_home }}/.cargo/bin/cargo"
    rustup_rustup_path: "{{ helix_user_home }}/.cargo/bin/rustup"
    rustup_effective_path: >-
      {{
        (helix_task_path | default('')) ~
        ':' ~ (helix_user_home ~ '/.local/bin') ~
        ':' ~ (helix_user_home ~ '/.cargo/bin') ~
        ':' ~ (ansible_facts['env']['PATH'] | default(''))
      }}

- name: Rustup | Check cargo (absolute path)
  stat:
    path: "{{ rustup_cargo_path }}"
  register: rustup_cargo_stat

# -----------------------------
# macOS: rustup-init bootstrap
# -----------------------------
- block:
    - name: Rustup | Ensure ~/.local/bin exists
      file:
        path: "{{ helix_user_home }}/.local/bin"
        state: directory
        mode: "0755"

    - name: Rustup | Install rustup-init via Homebrew
      homebrew:
        name: rustup-init
        state: present

    - name: Rustup | Run rustup-init (non-interactive, no PATH edits)
      command: rustup-init -y --no-modify-path --default-toolchain stable
      args:
        creates: "{{ rustup_cargo_path }}"
      environment:
        RUSTUP_HOME: "{{ rustup_rustup_home }}"
        CARGO_HOME: "{{ rustup_cargo_home }}"
        PATH: "{{ rustup_effective_path }}"
      register: rustup_init_run
      changed_when: rustup_init_run.rc == 0
      failed_when: rustup_init_run.rc != 0

  when:
    - ansible_facts['system'] == 'Darwin'
    - not rustup_cargo_stat.stat.exists

# -----------------------------
# Debian/Ubuntu: apt fallback
# -----------------------------
- block:
    - name: Rustup | Install cargo via apt (Debian/Ubuntu fallback)
      become: yes
      apt:
        name:
          - cargo
          - rustc
        state: present
        update_cache: yes
  when:
    - ansible_facts['os_family'] == 'Debian'
    - not rustup_cargo_stat.stat.exists

# -----------------------------
# Final re-check + export fact
# -----------------------------
- name: Rustup | Re-check cargo (absolute path)
  stat:
    path: "{{ rustup_cargo_path }}"
  register: rustup_cargo_stat2

- name: Rustup | Set rustup_has_cargo fact
  set_fact:
    rustup_has_cargo: "{{ rustup_cargo_stat2.stat.exists | bool }}"
    cargo_cmd: >-
      {{
        (rustup_cargo_stat2.stat.exists | bool)
        | ternary(rustup_cargo_path, 'cargo')
      }}

- name: Rustup | Warn if cargo still missing (do not fail)
  debug:
    msg: "rustup role ran, but cargo is still missing at {{ rustup_cargo_path }} (PATH may also not include it yet)."
  when: not rustup_has_cargo
