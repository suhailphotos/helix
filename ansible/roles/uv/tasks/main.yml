---
# 1) Host-level gate: only run uv on hosts that explicitly opt in
- name: uv disabled on this host - skipping uv role
  debug:
    msg: "uv is not enabled on this host (uv_enabled != true); skipping uv role."
  when: not (uv_enabled | default(false) | bool)

- meta: end_host
  when: not (uv_enabled | default(false) | bool)

# NEW: define uv_user + uv_home early (so become_user / HOME works)
- name: uv | Determine target user/home
  set_fact:
    uv_user: "{{ helix_user | default(ansible_facts['user_id']) }}"
    uv_home: >-
      {{
        helix_user_home
        | default(ansible_facts['user_dir'])
        | default(
            ((helix_user | default(ansible_facts['user_id'])) == 'root')
            | ternary('/root', '/home/' ~ (helix_user | default(ansible_facts['user_id'])))
          )
      }}

# 2) Compute paths and project list (macOS vs Linux)
- name: Compute paths and project list
  set_fact:
    matrix_packages_dir: "{{ matrix_packages_dir | default(matrix_root + '/packages') }}"
    uv_projects: >-
      {{ uv_projects | default((uv_projects_macos | default([])) if ansible_facts['system'] == 'Darwin'
                               else (uv_projects_linux | default([]))) }}
    uv_pin_map: "{{ uv_python_pin_map | default({'3.11': (houdini_python_patch | default('3.11.7'))}) }}"
    uv_default_minor: "{{ uv_default_minor | default('3.11') }}"

# 3) Build PATH used for checks/installs
- name: uv | Build PATH
  set_fact:
    uv_path_env: "{{ helix_task_path | default(ansible_facts['env']['PATH'] | default('')) }}"

# 4) Detect uv
- name: uv | Detect uv
  command: "command -v uv"
  register: uv_cmd
  changed_when: false
  failed_when: false
  environment:
    PATH: "{{ uv_path_env }}"

# 5) If missing on macOS, tell yourself to fix brew (donâ€™t curl-install on mac)
- name: uv | Missing on macOS (brew should provide it)
  fail:
    msg: "uv not found. On macOS, install via Homebrew: brew install uv"
  when:
    - uv_cmd.rc != 0
    - ansible_facts['system'] == 'Darwin'

# 6) If missing on Linux, install per-user
- name: uv | Install uv (Linux, per-user)
  become: yes
  become_user: "{{ uv_user }}"
  shell: |
    set -euo pipefail
    curl -LsSf https://astral.sh/uv/install.sh | sh
  args:
    executable: /bin/bash
  environment:
    HOME: "{{ uv_home }}"
    PATH: "{{ uv_path_env }}"
  when:
    - uv_cmd.rc != 0
    - ansible_facts['system'] == 'Linux'

# 7) Re-detect after install
- name: uv | Re-detect uv after install
  command: "command -v uv"
  register: uv_cmd2
  changed_when: false
  failed_when: false
  environment:
    PATH: "{{ uv_path_env }}"

- name: uv still missing - skipping uv role
  debug:
    msg: "uv still not found after install attempt; skipping uv."
  when: uv_cmd2.rc != 0

- meta: end_host
  when: uv_cmd2.rc != 0
