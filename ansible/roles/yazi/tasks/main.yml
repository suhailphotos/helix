---
# roles/yazi/tasks/main.yml

- set_fact:
    yazi_manage_prereqs: "{{ yazi_manage_prereqs | default(false) | bool }}"

# Try to find yazi first
- name: Check for yazi
  command: bash -lc 'command -v yazi'
  register: yazi_cmd
  changed_when: false
  failed_when: false
  environment:
    PATH: "{{ ansible_env.PATH }}:{{ ansible_env.HOME }}/.local/bin"

# macOS prerequisites (only if enabled)
- name: macOS | install Yazi prerequisites
  when: ansible_system == "Darwin" and yazi_manage_prereqs
  community.general.homebrew:
    name:
      - ffmpeg
      - jq
      - poppler
      - imagemagick
      - resvg
      - 7zip
      - fd
      - ripgrep
      - fzf
      - zoxide
      - bat
    state: present
    path: "{{ brew_bin | default('/opt/homebrew/bin/brew') }}"

# Debian/Ubuntu prerequisites (only if enabled)
- name: Debian/Ubuntu | install Yazi prerequisites
  when: ansible_facts.os_family == "Debian" and yazi_manage_prereqs
  become: yes
  apt:
    name:
      - file
      - fd-find
      - ripgrep
      - fzf
      - jq
      - ffmpeg
      - poppler-utils
      - p7zip-full
      - imagemagick
      - xclip
      - wl-clipboard
    state: present
    update_cache: yes

- name: Debian/Ubuntu | install resvg (best-effort)
  when: ansible_facts.os_family == "Debian" and yazi_manage_prereqs
  become: yes
  apt:
    name: resvg
    state: present
    update_cache: yes
  register: resvg_apt
  failed_when: false

# -----------------------
# macOS: Homebrew install
# -----------------------
- name: macOS | install yazi with brew
  when: ansible_system == "Darwin" and yazi_cmd.rc != 0
  community.general.homebrew:
    name: yazi
    state: present
    path: "{{ brew_bin | default('/opt/homebrew/bin/brew') }}"

# -----------------------
# Debian/Ubuntu: apt first
# -----------------------
- name: Debian/Ubuntu | try apt install
  when: ansible_facts.os_family == "Debian" and yazi_cmd.rc != 0
  become: yes
  apt:
    name: yazi
    state: present
    update_cache: yes
  register: yazi_apt
  failed_when: false

# Recheck after any package-manager install (brew or apt)
- name: Recheck yazi after package manager
  command: bash -lc 'command -v yazi'
  register: yazi_cmd_after_pm
  changed_when: false
  failed_when: false
  environment:
    PATH: "{{ ansible_env.PATH }}:{{ ansible_env.HOME }}/.local/bin"

# -----------------------
# Fallback installers (split by OS so we don't touch apt vars on macOS)
# -----------------------
- name: Install yazi via official script (fallback) [non-Debian]
  when: ansible_facts.os_family != "Debian" and yazi_cmd_after_pm.rc != 0
  shell: |
    set -e
    curl -fsSL https://yazi-rs.github.io/install.sh -o /tmp/yazi_install.sh
    sh /tmp/yazi_install.sh -y -b "{{ ansible_env.HOME }}/.local/bin"
  args: { executable: /bin/bash }
  changed_when: false

- name: Install yazi via official script (fallback) [Debian]
  when: ansible_facts.os_family == "Debian" and yazi_cmd_after_pm.rc != 0
  shell: |
    set -e
    curl -fsSL https://yazi-rs.github.io/install.sh -o /tmp/yazi_install.sh
    sh /tmp/yazi_install.sh -y -b "{{ ansible_env.HOME }}/.local/bin"
  args: { executable: /bin/bash }
  changed_when: false

# Final check (make sure ~/.local/bin is on PATH)
- name: Final check
  command: bash -lc 'command -v yazi'
  register: yazi_cmd_final
  changed_when: false
  failed_when: false
  environment:
    PATH: "{{ ansible_env.PATH }}:{{ ansible_env.HOME }}/.local/bin"
