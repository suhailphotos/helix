---
# roles/tmux_setup/tasks/main.yml

# 1) Packages (Linux only)
- name: Install tmux and clipboard helpers (Linux)
  become: yes
  apt:
    name:
      - tmux
      - wl-clipboard
      - xclip
    state: present
    update_cache: yes
  when: ansible_facts['system'] != "Darwin"

# 2) Ensure XDG config dir exists
- name: Ensure ~/.config/tmux dir exists
  file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/tmux"
    state: directory
    mode: "0755"

# 3) Expect the canonical XDG file: ~/.config/tmux/tmux.conf
- name: Check for ~/.config/tmux/tmux.conf
  stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/tmux/tmux.conf"
  register: xdg_tmux
  changed_when: false

- name: Note about missing XDG tmux config
  debug:
    msg: "tmux: ~/.config/tmux/tmux.conf not found (Bindu should provide it)."
  when: not xdg_tmux.stat.exists

# 4) Backup legacy ~/.tmux.conf (if it exists from older setups)
- name: Check for legacy ~/.tmux.conf
  stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.tmux.conf"
  register: home_tmux
  changed_when: false

- name: Backup existing ~/.tmux.conf
  copy:
    src: "{{ ansible_facts['env']['HOME'] }}/.tmux.conf"
    dest: "{{ ansible_facts['env']['HOME'] }}/.tmux.conf.bak"
    remote_src: yes
    force: no
  when: home_tmux.stat.exists

# 5) TPM (tmux plugin manager) at default location
- name: Ensure ~/.tmux/plugins exists
  file:
    path: "{{ ansible_facts['env']['HOME'] }}/.tmux/plugins"
    state: directory
    mode: "0755"

- name: Install/Update tmux-plugins/tpm
  git:
    repo: "https://github.com/tmux-plugins/tpm"
    dest: "{{ ansible_facts['env']['HOME'] }}/.tmux/plugins/tpm"
    depth: 1
    single_branch: yes
    update: yes
    accept_hostkey: yes
  register: tpm_git
  changed_when: tpm_git.after != tpm_git.before or tpm_git.remote_url_changed | default(false)

# 6) Reload config if already inside tmux (best-effort)
- name: Reload tmux config if running inside tmux
  shell: tmux source-file "$HOME/.config/tmux/tmux.conf"
  args: { executable: /bin/bash }
  changed_when: false
  failed_when: false
  when:
    - ansible_facts['env']['TMUX'] is defined
    - (ansible_facts['env']['TMUX'] | length) > 0
    - xdg_tmux.stat.exists
