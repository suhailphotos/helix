---
# roles/cargo_crates/tasks/main.yml

- name: Cargo crates | Build crate list
  set_fact:
    cargo_crate_list: "{{ (cargo_crates_common | default([])) + (cargo_crates_macos | default([])) + (cargo_crates_linux | default([])) }}"

- name: Cargo crates | Nothing to do
  debug:
    msg: "No cargo crates requested."
  when: (cargo_crate_list | length) == 0

- name: Cargo crates | Check cargo (absolute path)
  stat:
    path: "{{ helix_user_home }}/.cargo/bin/cargo"
  register: cargo_crates_cargo_stat
  when: (cargo_crate_list | length) > 0

- name: Cargo crates | Ensure cargo exists (include rustup if needed)
  include_role:
    name: rustup
  when:
    - (cargo_crate_list | length) > 0
    - not cargo_crates_cargo_stat.stat.exists

- name: Cargo crates | Re-check cargo
  stat:
    path: "{{ helix_user_home }}/.cargo/bin/cargo"
  register: cargo_crates_cargo_stat2
  when: (cargo_crate_list | length) > 0

- name: Cargo crates | Skip if cargo still missing
  debug:
    msg: "Skipping cargo_crates: cargo is still missing after rustup attempt."
  when:
    - (cargo_crate_list | length) > 0
    - not cargo_crates_cargo_stat2.stat.exists

- name: Cargo crates | Install crates
  command: >-
    {{ helix_user_home }}/.cargo/bin/cargo install {{ item.name }}
  environment:
    PATH: >-
      {{
        (helix_task_path | default('')) ~
        ':' ~ (helix_user_home ~ '/.cargo/bin') ~
        ':' ~ (ansible_facts['env']['PATH'] | default(''))
      }}
  loop: "{{ cargo_crate_list }}"
  loop_control:
    label: "{{ item.name }}"
  when:
    - (cargo_crate_list | length) > 0
    - cargo_crates_cargo_stat2.stat.exists
