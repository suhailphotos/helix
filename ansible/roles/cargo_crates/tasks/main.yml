---
# roles/cargo_crates/tasks/main.yml
# Installs user cargo crates. Ensures cargo exists first.

- name: Build cargo crate list
  set_fact:
    helix_task_path_effective: "{{ helix_task_path | default(helix_user_home ~ '/.local/bin:' ~ helix_user_home ~ '/.cargo/bin') }}"
    cargo_crates_all: >-
      {{
        (cargo_crates_common | default([]))
        + (
          cargo_crates_macos | default([]) if ansible_facts['system'] == 'Darwin'
          else cargo_crates_linux | default([])
        )
      }}

- name: Nothing to do if no cargo crates are listed
  debug:
    msg: "cargo_crates: no crates configured."
  when: (cargo_crates_all | length) == 0

- name: Check for cargo
  command: bash -lc "command -v cargo"
  register: cargo_check
  changed_when: false
  failed_when: false
  environment:
    PATH: "{{ helix_task_path_effective }}:{{ ansible_env.PATH }}"

- name: Install rust toolchain if cargo is missing
  include_role:
    name: rustup
  when:
    - (cargo_crates_all | length) > 0
    - cargo_check.rc != 0

- name: Verify cargo is available
  command: bash -lc "command -v cargo"
  register: cargo_check2
  changed_when: false
  failed_when: (cargo_crates_all | length) > 0 and cargo_check2.rc != 0
  environment:
    PATH: "{{ helix_task_path_effective }}:{{ ansible_env.PATH }}"

# -----------------------------
# Install crates (idempotent-ish)
# -----------------------------
- name: Install configured cargo crates
  shell: |
    set -euo pipefail

    name="{{ item.name }}"
    bin="{{ item.bin | default(item.name) }}"

    if command -v "$bin" >/dev/null 2>&1; then
      exit 0
    fi

    # pick install strategy
    mode="{{ cargo_install_mode | default('auto') }}"
    if [ "$mode" = "binstall" ]; then
      cargo binstall -y "$name"
    elif [ "$mode" = "auto" ] && command -v cargo-binstall >/dev/null 2>&1; then
      cargo binstall -y "$name"
    else
      if [ -n "{{ item.version | default('') }}" ]; then
        cargo install --locked --version "{{ item.version }}" "$name"
      elif [ -n "{{ item.git | default('') }}" ]; then
        # git install support (optional fields: tag, rev)
        if [ -n "{{ item.rev | default('') }}" ]; then
          cargo install --locked --git "{{ item.git }}" --rev "{{ item.rev }}" "$name"
        elif [ -n "{{ item.tag | default('') }}" ]; then
          cargo install --locked --git "{{ item.git }}" --tag "{{ item.tag }}" "$name"
        else
          cargo install --locked --git "{{ item.git }}" "$name"
        fi
      else
        cargo install --locked "$name"
      fi
    fi
  args:
    executable: /bin/bash
  environment:
    PATH: "{{ helix_task_path_effective }}:{{ ansible_env.PATH }}"
  loop: "{{ cargo_crates_all }}"
  loop_control:
    label: "{{ item.name }}"
  when: (cargo_crates_all | length) > 0
