---
# roles/nvidia_container_toolkit/tasks/main.yml

- name: NVIDIA Container Toolkit | gated off for non-GPU hosts
  ansible.builtin.debug:
    msg: "nvidia_gpu_host is false; skipping nvidia_container_toolkit."
  when: not (nvidia_gpu_host | default(false)) | bool

- meta: end_host
  when: not (nvidia_gpu_host | default(false)) | bool

- name: NVIDIA Container Toolkit | assert Ubuntu
  ansible.builtin.assert:
    that:
      - ansible_facts['distribution'] == 'Ubuntu'
    fail_msg: "nvidia_container_toolkit supports Ubuntu only. Detected: {{ ansible_facts['distribution'] }}"

# Must have drivers working first (your requirement)
- name: NVIDIA Container Toolkit | check nvidia-smi works
  ansible.builtin.command: nvidia-smi
  register: nvidia_smi
  changed_when: false
  failed_when: false

- name: NVIDIA Container Toolkit | skip if NVIDIA driver not ready
  ansible.builtin.debug:
    msg: |
      NVIDIA driver not ready (nvidia-smi failed). Skipping container toolkit install.
      rc={{ nvidia_smi.rc }}
      stdout={{ nvidia_smi.stdout | default('') }}
      stderr={{ nvidia_smi.stderr | default('') }}
  when: nvidia_smi.rc != 0

- meta: end_host
  when: nvidia_smi.rc != 0

- name: NVIDIA Container Toolkit | prerequisites
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gpg
    state: present
    update_cache: yes

- name: NVIDIA Container Toolkit | add apt repo keyring + list
  ansible.builtin.shell: |
    set -euo pipefail
    curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey \
      | gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg

    curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list \
      | sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' \
      > /etc/apt/sources.list.d/nvidia-container-toolkit.list
  args:
    executable: /bin/bash
    creates: /etc/apt/sources.list.d/nvidia-container-toolkit.list

- name: NVIDIA Container Toolkit | apt update
  ansible.builtin.apt:
    update_cache: yes

- name: NVIDIA Container Toolkit | install toolkit
  ansible.builtin.apt:
    name:
      - nvidia-container-toolkit
    state: present
