---
# roles/bindu_config_repo/tasks/main.yml
# Ensure ~/.config is a git clone of your Bindu repo on the branch you choose.
# Works on macOS + Linux, and for root + non-root.
#
# Optional overrides (group_vars/host_vars):
#   bindu_remote: git@github.com:suhailphotos/bindu.git (or https://...)
#   bindu_branch: main
#   bindu_config_dir: /path/to/.config
#   helix_user: suhail (if you want to force ownership)
#   helix_user_home: /home/suhail (if you want to force home)

# -----------------------------
# Defaults (must be split across tasks; set_fact does not allow intra-task references)
# -----------------------------
- name: Defaults - remote/branch/user
  set_fact:
    bindu_remote: "{{ bindu_remote | default('https://github.com/suhailphotos/bindu.git') }}"
    bindu_branch: "{{ bindu_branch | default('main') }}"
    # Who should own ~/.config on THIS host?
    bindu_user: "{{ helix_user | default(ansible_user_id) }}"

- name: Defaults - home + config dir
  set_fact:
    # Prefer explicit helix_user_home (you already set this in group_vars/all.yml),
    # otherwise fall back to facts/env. Avoid referencing bindu_user here.
    bindu_home: "{{ helix_user_home | default(ansible_facts['user_dir'] | default(ansible_env.HOME | default(''))) }}"
    bindu_config_dir: "{{ bindu_config_dir | default((helix_user_home | default(ansible_facts['user_dir'] | default(ansible_env.HOME | default('')))) + '/.config') }}"

- name: Defaults - determine primary group name for bindu_user
  command: "id -gn {{ bindu_user }}"
  register: bindu_group_cmd
  changed_when: false
  failed_when: false

- name: Defaults - set bindu_group
  set_fact:
    # macOS users commonly have group 'staff' (not the username), so we must use the name from `id -gn`.
    bindu_group: "{{ (bindu_group_cmd.stdout | default('') | trim) | default(bindu_user) }}"

# -----------------------------
# Existing ~/.config handling
# -----------------------------
- name: Stat ~/.config
  stat:
    path: "{{ bindu_config_dir }}"
  register: cfg

- name: Stat ~/.config/.git (only if ~/.config exists)
  stat:
    path: "{{ bindu_config_dir }}/.git"
  register: cfg_git
  when: cfg.stat.exists

- name: Assume not a repo when cfg_git undefined
  set_fact:
    cfg_is_repo: false
  when: cfg_git is not defined

- name: Flag as repo if .git exists
  set_fact:
    cfg_is_repo: "{{ cfg_git.stat.exists | default(false) }}"
  when: cfg_git is defined

- name: Move aside pre-existing non-repo ~/.config
  when:
    - cfg.stat.exists
    - not cfg_is_repo
  shell: |
    set -e
    mv "{{ bindu_config_dir }}" "{{ bindu_config_dir }}.pre-bindu.{{ ansible_date_time.iso8601_basic }}"
    mkdir -p "{{ bindu_config_dir | dirname }}"
  args:
    executable: /bin/bash

- name: Read origin for existing repo
  command: git -C "{{ bindu_config_dir }}" remote get-url origin
  register: existing_origin
  changed_when: false
  failed_when: false
  when: cfg_is_repo

- name: Normalize origin/remote URLs (for comparison)
  set_fact:
    bindu_origin_norm: >-
      {{
        (existing_origin.stdout | default(''))
        | regex_replace('^ssh://', '')
        | regex_replace('^git@github.com:', 'https://github.com/')
        | regex_replace('^https?://[^@]+@', 'https://')
        | regex_replace('\.git$', '')
        | lower
      }}
    bindu_remote_norm: >-
      {{
        bindu_remote
        | regex_replace('^ssh://', '')
        | regex_replace('^git@github.com:', 'https://github.com/')
        | regex_replace('^https?://[^@]+@', 'https://')
        | regex_replace('\.git$', '')
        | lower
      }}
  when: cfg_is_repo

- name: If repo is not Bindu, move it aside
  when:
    - cfg_is_repo
    - bindu_origin_norm | default('') != bindu_remote_norm | default('')
  shell: |
    set -e
    mv "{{ bindu_config_dir }}" "{{ bindu_config_dir }}.pre-bindu.{{ ansible_date_time.iso8601_basic }}"
  args:
    executable: /bin/bash

# -----------------------------
# Ensure parent + clone
# -----------------------------
- name: Ensure parent exists (permissions only)
  file:
    path: "{{ bindu_config_dir | dirname }}"
    state: directory
    mode: "0755"

- name: Ensure ~/.config parent exists and is owned by bindu_user
  become: yes
  file:
    path: "{{ bindu_config_dir | dirname }}"
    state: directory
    owner: "{{ bindu_user }}"
    group: "{{ bindu_group }}"
    mode: "0755"

- name: Clone/update Bindu into ~/.config (as bindu_user)
  become: yes
  become_user: "{{ bindu_user }}"
  git:
    repo: "{{ bindu_remote }}"
    dest: "{{ bindu_config_dir }}"
    version: "{{ bindu_branch }}"
    depth: 1
    single_branch: yes
    update: yes
    accept_hostkey: yes
    force: yes

- name: Ensure we track origin/{{ bindu_branch }}
  become: yes
  become_user: "{{ bindu_user }}"
  shell: |
    set -e
    git -C "{{ bindu_config_dir }}" checkout -q "{{ bindu_branch }}"
    git -C "{{ bindu_config_dir }}" branch --set-upstream-to "origin/{{ bindu_branch }}" "{{ bindu_branch }}" || true
  args:
    executable: /bin/bash

- name: Ensure ~/.config repo is owned by bindu_user
  become: yes
  file:
    path: "{{ bindu_config_dir }}"
    state: directory
    owner: "{{ bindu_user }}"
    group: "{{ bindu_group }}"
    recurse: yes

- name: Ignore macOS metadata
  lineinfile:
    path: "{{ bindu_config_dir }}/.gitignore"
    create: yes
    line: "**/.DS_Store"
    state: present

